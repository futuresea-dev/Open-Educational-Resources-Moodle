define("local_oer/output",["exports","local_oer/service","core/templates","local_oer/config","core/modal_factory","core/modal_events","core/fragment","core/str"],(function(_exports,Service,Templates,Config,ModalFactory,ModalEvents,Fragment,Str){function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var r=new WeakMap,t=new WeakMap;return(_getRequireWildcardCache=function(e){return e?t:r})(e)}function _interopRequireWildcard(e,r){if(!r&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var t=_getRequireWildcardCache(r);if(t&&t.has(e))return t.get(e);var n={__proto__:null},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var u in e)if("default"!==u&&{}.hasOwnProperty.call(e,u)){var i=a?Object.getOwnPropertyDescriptor(e,u):null;i&&(i.get||i.set)?Object.defineProperty(n,u,i):n[u]=e[u]}return n.default=e,t&&t.set(e,n),n
/**
   * Open Educational Resources Plugin
   *
   * @author     Christian Ortner <christian.ortner@tugraz.at>
   * @copyright  2022-2023 Educational Technologies, Graz, University of Technology
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.showForm=_exports.showFiles=_exports.prepareFiles=void 0,Service=_interopRequireWildcard(Service),Templates=_interopRequireWildcard(Templates),Config=_interopRequireWildcard(Config),ModalFactory=_interopRequireWildcard(ModalFactory),ModalEvents=_interopRequireWildcard(ModalEvents),Fragment=_interopRequireWildcard(Fragment),Str=_interopRequireWildcard(Str);const showFiles=(init,keepFocus)=>{const output=Config.getOutputValues(init),oldSearchInput=document.getElementById("local_oer_searchFilecardsInput");let oldSearchValue="";null!==oldSearchInput&&(oldSearchValue=oldSearchInput.value),Templates.render("local_oer/files",output).then((function(html,js){Templates.replaceNodeContents("#local-oer-overview",html,js);const searchInput=document.getElementById("local_oer_searchFilecardsInput");keepFocus&&null!==searchInput&&(searchInput.value=oldSearchValue,searchInput.focus())})).fail((function(error){window.console.debug(error)})),showPagination()};_exports.showFiles=showFiles;_exports.showForm=(type,title,options)=>{const params=JSON.stringify(options),courseid=document.getElementById("local_oer_files_main_area").dataset.courseid,context=document.getElementById("local_oer_files_main_area").dataset.context,args={courseid:courseid,formtype:type,params:params},form=Fragment.loadFragment("local_oer","formdata",context,args);form.done((function(data){!1!==data.includes('<input name="nosave" type="hidden" value="1" />')&&(type="nosave"),showFormModal(form,type,title,options)}))};const showFormModal=(form,type,title,options)=>{const element=document.getElementById("local_oer_files_main_area"),modaltype="nosave"===type?ModalFactory.types.CANCEL:ModalFactory.types.SAVE_CANCEL;ModalFactory.create({type:modaltype,title:title,body:form}).then((function(modal){switch(modal.setLarge(),modal.show(),type){case"FileinfoForm":case"FileinfoFormSave":initPersonButtonListener(),addRemoveTagListener("storedperson"),initSetPreferenceListener(modal),addInputFieldInputListener("stored","tags");break;case"PreferenceForm":case"PreferenceFormSave":initPersonButtonListener(),addRemoveTagListener("storedperson"),addInputFieldInputListener("stored","tags")}modal.getRoot().on(ModalEvents.hidden,(function(){modal.destroy()})),modal.getRoot().on(ModalEvents.save,(function(){saveForm(modal,element,options,type,title)}))})).catch((function(error){window.console.debug(error)}))},saveForm=(modal,element,options,type,title)=>{const formData=modal.getRoot().find("form").serialize(),saveargs={courseid:element.dataset.courseid,formtype:type+"Save",params:JSON.stringify(Object.assign(options,{settings:formData}))},context=element.dataset.context,formSubmit=Fragment.loadFragment("local_oer","formdata",context,saveargs);formSubmit.done((function(response){-1!==response.indexOf("<form")?(modal.destroy(),options.hasOwnProperty("preference")&&(delete options.preference,replaceFileInfo(Service.loadFile(options.identifier))),showFormModal(formSubmit,type,title,options)):"FileinfoForm"===type?replaceFileInfo(Service.loadFile(options.identifier)):"PreferenceForm"===type&&prepareFiles(Service.loadFiles(),!0)})).catch((function(error){window.console.debug("Form submission failed",error)}))},replaceFileInfo=promises=>{promises[0].done((function(response){const filelist=document.getElementById("local-oer-overview-filelist").innerHTML,output=JSON.parse(filelist);output.files.forEach((function(file,index){file.identifier===response.file.identifier&&(output.files[index]=response.file)})),document.getElementById("local-oer-overview-filelist").innerHTML=JSON.stringify(output),showFiles(!1,!0)}))},prepareFiles=(promises,init)=>{promises[0].done((function(response){document.getElementById("local-oer-overview-filelist").innerHTML=JSON.stringify(response),showFiles(init,!0)}))};_exports.prepareFiles=prepareFiles;const addInputFieldInputListener=(prefix,area)=>{showTags(prefix+area),document.getElementById("id_"+area).addEventListener("keypress",(function(e){"Enter"===e.key&&(addStoredTag(prefix,area),showTags(prefix+area))})),document.getElementById("id_"+area).addEventListener("focusout",(function(){0!==area.length&&(addStoredTag(prefix,area),showTags(prefix+area))})),addRemoveTagListener(prefix+area)},addStoredTag=(prefix,tagarea)=>{let tag=document.getElementById("id_"+tagarea).value;tag=tag.replace(","," ").trim();const tags=document.querySelector('[name="'+prefix+tagarea+'"]').value;document.getElementById("id_"+tagarea).value="",tags.includes(tag)||(document.querySelector('[name="'+prefix+tagarea+'"]').value=""===tags?tag:tags+","+tag)},addRemoveTagListener=tagarea=>{document.getElementById("local_oer_"+tagarea+"_tagarea").addEventListener("click",(function(e){if(e.target.dataset.name===tagarea)if("storedperson"===tagarea)removePerson(e.target.dataset);else{let name=e.target.dataset.value,tags=document.querySelector('[name="'+tagarea+'"]').value.split(","),result=[];tags.forEach((function(tag){""!==tag&&tag!==name&&result.push(tag)})),document.querySelector('[name="'+tagarea+'"]').value=result.join(","),showTags(tagarea)}}))},showTags=tagarea=>{let entries=document.querySelector('[name="'+tagarea+'"]').value,tags={tags:[]};entries.length>0?(entries=entries.split(","),entries.forEach((function(entry){tags.tags.push({tagarea:tagarea,tagvalue:entry,tag:entry})}))):tags=!1,Templates.render("local_oer/tags",tags).then((function(html,js){Templates.replaceNodeContents("#local_oer_"+tagarea+"_tagarea",html,js)})).fail((function(e){window.console.log(e)}))},initSetPreferenceListener=modal=>{const button=document.getElementById("local_oer_preferenceResetButton");null!==button&&button.addEventListener("click",(function(action){action.preventDefault();let options={identifier:button.dataset.identifier,preference:button.dataset.preference},element=document.getElementById("local_oer_files_main_area");saveForm(modal,element,options,"FileinfoForm","FileinfoForm")}))},initPersonButtonListener=()=>{const button=document.getElementById("local_oer_addPersonButton");null!==button&&(showPersons(),button.addEventListener("click",(function(action){action.preventDefault(),showPersonForm()})))},showPersonForm=setInvalid=>{void 0===setInvalid&&(setInvalid=!1);const creator=document.querySelector('[name="creator"]').value,context=document.getElementById("local_oer_files_main_area").dataset.context,form=Fragment.loadFragment("local_oer","personform",context,{creator:creator});form.done((function(){Str.get_string("addpersonbtn","local_oer").done((function(localizedTitle){ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:localizedTitle,body:form}).then((function(modal){if(modal.setSaveButtonText(localizedTitle),modal.getRoot().on(ModalEvents.hidden,(function(){modal.destroy()})),modal.getRoot().on(ModalEvents.save,(function(){const fields=modal.getRoot().find("form").serialize().split("&");let role="",firstname="",lastname="";fields.forEach((function(field){let pair=field.split("="),key=pair[0],value=pair[1];switch(key){case"role":role=value;break;case"firstname":firstname=value;break;case"lastname":lastname=value}}));addPerson({role:role,firstname:firstname,lastname:lastname})})),modal.show(),setInvalid){let element=document.getElementById("id_firstname");element.classList.add("is-invalid"),element=document.getElementById("id_lastname"),element.classList.add("is-invalid")}})).catch((function(error){window.console.debug(error)}))}))}))},addPerson=person=>{let names=document.querySelector('[name="storedperson"]').value;if(""!==names){names=JSON.parse(names);let found=!1,update=!1;if(names.persons.forEach((function(storedname,key){person.role===storedname.role&&person.firstname===storedname.firstname&&person.lastname===storedname.lastname&&(found=!0),person.role===storedname.role&&person.firstname+" "+person.lastname===storedname.fullname&&(found=!0,update=!0,names.persons[key].firstname=person.firstname,names.persons[key].lastname=person.lastname)})),""===person.firstname||""===person.lastname)return void showPersonForm(!0);found?update&&(document.querySelector('[name="storedperson"]').value=JSON.stringify(names)):(names.persons.push(person),document.querySelector('[name="storedperson"]').value=JSON.stringify(names))}else document.querySelector('[name="storedperson"]').value=JSON.stringify({persons:[person]});showPersons()},removePerson=person=>{let entries=document.querySelector('[name="storedperson"]').value;if(""===entries)return;entries=JSON.parse(entries);const persons={persons:[]};entries.persons.forEach((function(storedperson){person.role===storedperson.role&&(person.firstname===storedperson.firstname&&person.lastname===storedperson.lastname||person.fullname===storedperson.fullname)||persons.persons.push(storedperson)})),document.querySelector('[name="storedperson"]').value=JSON.stringify(persons),showPersons()},showPersons=()=>{let entries=document.querySelector('[name="storedperson"]').value;if(""===entries)return;const roles=JSON.parse(document.querySelector('[name="personroletypes"]').value);let strings=[];roles.forEach((function(role){strings.push({key:role[1],component:role[2]})})),Str.get_strings(strings).then((function(results){entries=JSON.parse(entries);let persons={persons:[]};entries.persons.forEach((function(person){let localizedrole=results[0];roles.forEach((function(role,index){role[0]===person.role&&(localizedrole=results[index])})),persons.persons.push({role:person.role,firstname:person.firstname,lastname:person.lastname,fullname:person.fullname,name:decodeURI(localizedrole+": "+(void 0===person.fullname?person.firstname+" "+person.lastname:person.fullname))})})),renderPersonsTemplate(persons)})).fail((function(e){window.console.debug(e)}))},renderPersonsTemplate=persons=>{Templates.render("local_oer/persons",persons).then((function(html,js){Templates.replaceNodeContents("#local_oer_storedperson_tagarea",html,js)})).fail((function(e){window.console.log(e)}))},showPagination=()=>{const courseid=document.getElementById("local_oer_files_main_area").dataset.courseid;let filecount=parseInt(localStorage.getItem("local-oer-pagination-filecount-"+courseid),10);const filelist=document.getElementById("local-oer-overview-filelist").innerHTML,filemax=JSON.parse(filelist).files.length;let selected=localStorage.getItem("local-oer-pagination-selected-"+courseid),page=parseInt(localStorage.getItem("local-oer-pagination-current-"+courseid),10),pages=1;if(isNaN(filecount)&&(filecount=filemax),"all"!==selected){null===selected&&(selected="8");const amount=parseInt(selected,10);pages=Math.ceil(filecount/amount)}const result=[];if(isNaN(page)&&(page=1),page>pages&&(localStorage.setItem("local-oer-pagination-current-"+courseid,"1"),page=1),pages<=10)for(let i=1;i<=pages;i++)result.push({page:i,active:i===page,disabled:!1});else page<3||page>pages-2?(result.push({page:1,active:1===page,disabled:!1}),result.push({page:2,active:2===page,disabled:!1}),result.push({page:3,active:3===page,disabled:!1}),result.push({page:"..",active:!1,disabled:!0}),result.push({page:pages-2,active:page===pages-2,disabled:!1}),result.push({page:pages-1,active:page===pages-1,disabled:!1}),result.push({page:pages,active:page===pages,disabled:!1})):3===page?(result.push({page:1,active:!1,disabled:!1}),result.push({page:2,active:!1,disabled:!1}),result.push({page:3,active:!0,disabled:!1}),result.push({page:4,active:!1,disabled:!1}),result.push({page:"..",active:!1,disabled:!0}),result.push({page:pages-1,active:page===pages-1,disabled:!1}),result.push({page:pages,active:page===pages,disabled:!1})):page===pages-2?(result.push({page:1,active:!1,disabled:!1}),result.push({page:2,active:!1,disabled:!1}),result.push({page:"..",active:!1,disabled:!0}),result.push({page:pages-3,active:!1,disabled:!1}),result.push({page:pages-2,active:!0,disabled:!1}),result.push({page:pages-1,active:!1,disabled:!1}),result.push({page:pages,active:page===pages,disabled:!1})):(result.push({page:1,active:!1,disabled:!1}),result.push({page:"..",active:!1,disabled:!0}),result.push({page:page-1,active:!1,disabled:!1}),result.push({page:page,active:!0,disabled:!1}),result.push({page:page+1,active:!1,disabled:!1}),result.push({page:"..",active:!1,disabled:!0}),result.push({page:pages,active:!1,disabled:!1}));const data={selectoptions:paginationSelectOptions(selected),control:1!==pages,previous:page>1,next:page<pages,pages:1!==pages&&result,filecount:filecount,filemax:filemax};Templates.render("local_oer/pagination",data).then((function(html,js){Templates.replaceNodeContents("#local-oer-pagination",html,js),addPaginationListeners(pages)})).fail((function(error){window.console.debug(error)}))},paginationSelectOptions=selected=>[{value:"4",selected:"4"===selected},{value:"8",selected:"8"===selected},{value:"12",selected:"12"===selected},{value:"16",selected:"16"===selected},{value:"32",selected:"32"===selected},{value:"64",selected:"64"===selected},{value:"all",selected:"all"===selected}],addPaginationListeners=pages=>{let courseid=document.getElementById("local_oer_files_main_area").dataset.courseid,selected=localStorage.getItem("local-oer-pagination-selected-"+courseid),page=localStorage.getItem("local-oer-pagination-current-"+courseid);null!==page&&"undefined"!==page||localStorage.setItem("local-oer-pagination-current-"+courseid,"1"),null!==selected&&"undefined"!==selected||localStorage.setItem("local-oer-pagination-selected-"+courseid,"8");let selectlistener=document.getElementById("local-oer-pagination-select"),pagelistener=document.getElementById("local-oer-pagination-pages");selectlistener.addEventListener("change",(function(action){action.preventDefault();let value=action.target.value;localStorage.setItem("local-oer-pagination-selected-"+courseid,value),localStorage.setItem("local-oer-pagination-current-"+courseid,"1"),showFiles(!1,!1)})),pagelistener.addEventListener("click",(function(action){action.preventDefault();let value=action.target.dataset.page;if(void 0===value||".."===value)return;let page=parseInt(localStorage.getItem("local-oer-pagination-current-"+courseid));switch(value){case"previous":value=page>1?page-1:1;break;case"next":value=page<pages?page+1:pages}localStorage.setItem("local-oer-pagination-current-"+courseid,value),showFiles(!1,!1)}))}}));

//# sourceMappingURL=output.min.js.map